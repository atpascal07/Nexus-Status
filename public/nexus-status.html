<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nexus-Status</title>
    <meta name="description" content="Statusseite – Nexus-Status" />
    <link rel="icon" href="/icon-nexus.svg" type="image/svg+xml">
    <style>
/* Layout helpers for the status page using your exact design */
*{ box-sizing: border-box; }
.container{ max-width:960px; margin-inline:auto; padding: 24px; }
.h1{ margin:0; font-size:1.25rem; }
.mt-4{ margin-top:.25rem; }
.mt-12{ margin-top:12px; }
.grid{ display:grid; gap:16px; margin-top:18px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
.card{ background: var(--surface); border:1px solid var(--border); border-radius: var(--radius); padding:16px; box-shadow: var(--shadow); }
.meta{ color:var(--muted); font-size:.9rem; }
.badge{ display:inline-flex; align-items:center; gap:8px; font-weight:600; font-size:.9rem; padding:6px 10px; border-radius:999px; border:1px solid var(--border); }
.dot{ width:8px; height:8px; border-radius:999px; }
.ok{ color:var(--ok); }
.warn{ color:var(--warn); }
.down{ color:var(--down); }
.dot.ok{ background:var(--ok); box-shadow:0 0 0 4px rgba(34,197,94,.14) }
.dot.warn{ background:var(--warn); box-shadow:0 0 0 4px rgba(245,158,11,.14) }
.dot.down{ background:var(--down); box-shadow:0 0 0 4px rgba(239,68,68,.14) }
.list{ display:grid; gap:10px; margin:0; padding:0; list-style:none; }
.row{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border:1px dashed var(--border); border-radius:12px; background: linear-gradient(0deg, rgba(255,255,255,.02), rgba(255,255,255,.02)); }
header, footer{ background: var(--surface-2); border-bottom:1px solid var(--border); }
header .container, footer .container{ display:flex; align-items:center; justify-content:space-between; gap:16px; }
.brand{ display:flex; align-items:center; gap:12px; font-weight:700; }
.brand .dot{ width:10px; height:10px; border-radius:999px; background:var(--ok); box-shadow:0 0 0 4px rgba(34,197,94,.18); }
.brand span{ font-size:1.1rem; letter-spacing: .3px; }
.status-banner{ display:flex; align-items:center; gap:12px; padding:16px 18px; border:1px solid var(--border); border-radius: var(--radius); background: linear-gradient(0deg, rgba(255,255,255,.02), rgba(255,255,255,.02)) , var(--surface); box-shadow: var(--shadow); }
.status-banner.warn .pulse::before, .status-banner.warn .pulse::after{ background:var(--warn); }
.status-banner.down .pulse::before, .status-banner.down .pulse::after{ background:var(--down); }
.pulse{ position:relative; width:10px; height:10px; }
.pulse::before, .pulse::after{ content:""; position:absolute; inset:0; border-radius:999px; background:var(--ok); }
.pulse::after{ animation:pulse 1.8s ease-out infinite; }
@keyframes pulse{ 0%{ transform:scale(1); opacity:.8 } 100%{ transform:scale(3.2); opacity:0 } }
.footer{ padding-block:18px; }
@media (max-width:480px){
    header .container{ flex-wrap: wrap; }
    .status-banner{ align-items:flex-start; flex-direction:column; }
}
    </style>
</head>
<body class="nexus-theme">
<header>
    <div class="container">
        <div class="brand">
            <div class="dot" aria-hidden="true"></div>
            <span>Nexus-Status</span>
        </div>
        <nav class="meta" aria-label="Links">
            <a href="#komponenten">Komponenten</a> ·
            <a href="#vorfaelle">Vorfälle</a> ·
            <a href="#uptime">Uptime</a>
        </nav>
    </div>
</header>

<main class="container">
    <section class="status-banner" id="status-banner" aria-labelledby="gesamtstatus">
        <div class="pulse" aria-hidden="true"></div>
        <div>
            <h1 id="gesamtstatus" class="h1">Status lädt …</h1>
            <p class="meta mt-4">Letzte Aktualisierung: <time id="last-updated" datetime="">wird geladen…</time></p>
        </div>
    </section>

    <section id="komponenten" class="grid" aria-labelledby="komponenten-heading">
        <div class="card">
            <h3 id="komponenten-heading">Komponenten</h3>
            <ul class="list" id="components-list"></ul>
            <p class="meta mt-12">Passe Komponenten in Uptime‑Kuma an; diese Seite rendert sie neu.</p>
        </div>

        <div id="vorfaelle" class="card">
            <h3>Aktuelle Vorfälle</h3>
            <div id="incidents"><p class="meta">Keine offenen Vorfälle gemeldet.</p></div>
        </div>

        <div id="uptime" class="card">
            <h3>Uptime (30 Tage)</h3>
            <ul class="list" id="uptime-list"></ul>
            <p class="meta mt-12">Werte aus der Uptime‑Kuma API.</p>
        </div>
    </section>
</main>

<footer>
    <div class="container footer">
        <small class="meta">© <span id="year"></span> Nexus-Status</small>
    </div>
</footer>

<script>
// Diese Seite versucht zuerst die neue API (/api/status) einer eingebauten Server-Variante.
// Fällt sonst zurück auf Nexus-Status Status-Page API (Public Status Page) falls verfügbar.
(async function(){
  const $ = sel => document.querySelector(sel);
  const componentsList = $('#components-list');
  const uptimeList = $('#uptime-list');
  const banner = $('#status-banner');
  const lastUpdatedEl = $('#last-updated');
  const statusTitle = $('#gesamtstatus');
  const incidentsEl = $('#incidents');
  $('#year').textContent = new Date().getFullYear();

  const clsFor = s => s === 'down' ? 'down' : (s === 'warn' ? 'warn' : 'ok');
  const labelFor = s => s === 'down' ? 'Outage' : (s === 'warn' ? 'Degradation' : 'Operational');
  const headlineFor = s => s === 'down' ? 'Störung – Wir untersuchen das Problem' : (s === 'warn' ? 'Teilweise Beeinträchtigung' : 'Alle Systeme betriebsbereit');

  function renderComponents(items){
    componentsList.innerHTML = '';
    for(const c of items){
      const li = document.createElement('li');
      const cls = clsFor(c.status);
      li.className = 'row';
      li.innerHTML = `
        <span>
          <strong>${c.name || c.displayName || c.slug || 'Service'}</strong><br>
          <span class="meta">${c.url || c.host || ''}${c.ping != null ? ' • ' + c.ping + 'ms' : ''}</span>
        </span>
        <span class="badge ${cls}"><span class="dot ${cls}"></span> ${labelFor(cls)}</span>`;
      componentsList.appendChild(li);
    }
  }

  function renderUptime(items){
    uptimeList.innerHTML = '';
    for(const c of items){
      const li = document.createElement('li');
      const cls = clsFor(c.status);
      const up = (c.uptime || c.uptime30d || 100).toFixed ? (c.uptime || c.uptime30d).toFixed(2) : c.uptime || c.uptime30d || '—';
      li.className = 'row';
      li.innerHTML = `<span><strong>${c.name || c.displayName || 'Service'}</strong></span>
      <span class="badge ${cls}"><span class="dot ${cls}"></span> ${up}%</span>`;
      uptimeList.appendChild(li);
    }
  }

  function renderBanner(overall, lastUpdated){
    banner.classList.remove('ok','warn','down'); banner.classList.add(clsFor(overall));
    statusTitle.textContent = headlineFor(overall);
    const dt = lastUpdated ? new Date(lastUpdated) : new Date();
    try{
      const fmt = new Intl.DateTimeFormat('de-AT', { dateStyle:'medium', timeStyle:'short' });
      lastUpdatedEl.textContent = fmt.format(dt);
      lastUpdatedEl.setAttribute('datetime', dt.toISOString());
    }catch(e){ lastUpdatedEl.textContent = dt.toLocaleString(); }
  }

  async function tryNewApi(){
    const res = await fetch('/api/status', { cache:'no-store' });
    if(!res.ok) throw new Error('no new api');
    const data = await res.json();
    const comps = data.components || [];
    renderComponents(comps);
    renderUptime(comps);
    renderBanner(data.overall || 'ok', data.lastUpdated);
  }

  async function tryKumaStatusPage(){
    // Public Status Page API schema varies; attempt a generic GET to /api/status-page/summary
    const res = await fetch('/api/status-page/summary', { cache:'no-store' });
    if(!res.ok) throw new Error('no kuma summary');
    const data = await res.json();
    const services = (data.services || data.monitors || []).map(s => ({
      name: s.name || s.displayName,
      status: (s.status === 1 || s.status === 'UP') ? 'ok' : (s.status === 2 ? 'warn' : 'down'),
      uptime: s.uptime || s.uptime30d || s.uptime24h || 100,
      ping: s.ping || s.avgPing || null,
      url: s.url || ''
    }));
    renderComponents(services);
    renderUptime(services);
    renderBanner(data.overallStatus || 'ok', data.lastUpdated || Date.now());
  }

  try{
    await tryNewApi();
  }catch(e){
    try{
      await tryKumaStatusPage();
    }catch(e2){
      statusTitle.textContent = 'Konnte keine Status-Daten laden';
    }
  }
})();
</script>
</body>
</html>
